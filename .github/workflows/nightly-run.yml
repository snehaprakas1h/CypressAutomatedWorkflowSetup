name: Nightly Cypress Tests

on:
  workflow_dispatch: 
  schedule:
    - cron: "0 1 * * 0" 

jobs:
  cypress-run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: cypress-io/github-action@v6

      - run: npx mochawesome-merge cypress/results/*.json > cypress/results/mochawesome.json

      - run: npx marge cypress/results/mochawesome.json -f mochawesome -o cypress/results

      - id: generate-summary
        run: |
          node get-summary.js cypress/results/mochawesome.json

      - name: List files 
        run: ls -l

      - name: Check for summary file
        uses: dorny/paths-filter@v2 
        id: filter
        with:
          filters: |
            summary:
              - 'cypress_summary.env'

      - run: |
          if [[ ${{ steps.filter.outputs.summary }} == 'true' ]]; then
            echo "CYPRESS_SUMMARY=$(cat cypress_summary.env)" >> $GITHUB_ENV
          else
            echo "CYPRESS_SUMMARY=No summary found" >> $GITHUB_ENV 
          fi

      - uses: actions/upload-artifact@v4 
        if: failure()
        with:
          name: cypress-screenshots
          path: cypress/screenshots

      - uses: actions/upload-artifact@v4 
        if: failure()
        with:
          name: cypress-videos
          path: cypress/videos

      - uses: actions/upload-artifact@v4  
        with:
          name: cypress-report
          path: cypress/results/mochawesome.html

      - name: Generate provenance attestation
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: cypress/results/mochawesome.html 

      - uses: dawidd6/action-send-mail@v3
        if: always()
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: Cypress Nightly Test Results
          to: ${{ secrets.RECIPIENT_EMAIL }}
          from: Cypress Tests <cypress-tests@example.com>
          body: |
            Cypress nightly tests have completed. 

            Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            ${{ env.CYPRESS_SUMMARY }}

            See the attached artifacts for details.